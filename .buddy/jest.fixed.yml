- pipeline: jest
  refs:
    - refs/heads/master
  events:
    - type: PUSH
  fail_on_prepare_env_warning: true
  trigger_conditions:
    - trigger_condition: OR
      trigger_operands:
        - trigger_condition: ON_CHANGE_AT_PATH
          trigger_condition_paths:
            - /.buddy/jest.fixed.yml
        - trigger_condition: ON_CHANGE_AT_PATH
          trigger_condition_paths:
            - /src/reporters/jest/
        - trigger_condition: ON_CHANGE_AT_PATH
          trigger_condition_paths:
            - /examples/jest/
        - trigger_condition: ON_CHANGE_AT_PATH
          trigger_condition_paths:
            - /src/core/
        - trigger_condition: ON_CHANGE_AT_PATH
          trigger_condition_paths:
            - /src/utils/
        - trigger_condition: ON_CHANGE_AT_PATH
          trigger_condition_paths:
            - package-lock.json
  variables:
    - key: BUDDY_LOGGER_DEBUG
      value: 1
      type: VAR
    - key: BUDDY_RUN_BRANCH
      type: VAR
    - key: BUDDY_RUN_COMMIT
      type: VAR
    - key: BUDDY_RUN_HASH
      type: VAR
    - key: BUDDY_RUN_PRE_COMMIT
      type: VAR
    - key: BUDDY_RUN_REF_NAME
      type: VAR
    - key: BUDDY_RUN_REF_TYPE
      type: VAR
    - key: BUDDY_RUN_URL
      type: VAR
    - key: BUDDY_SESSION_ID
      type: VAR
    - key: JEST_VERSION
      value: 30
      type: VAR
    - key: NODE_VERSION
      value: 22
      type: VAR
  actions:
    - action: Prepare environment for tests
      type: BUILD
      docker_image_name: buddy/localshell
      docker_image_tag: ubuntu_24.04
      execute_commands:
        - ./prepare-package-for-tests.sh
        - ./prepare-version.sh devDependencies jest $JEST_VERSION ./examples/jest
      setup_commands:
        - apt-get update && apt-get -y install jq
      shell: BASH
    - action: Collect Jest tests
      type: BUILD
      docker_image_name: library/node
      docker_image_tag: $NODE_VERSION
      execute_commands:
        - cd examples/jest
        - rm -rf node_modules package-lock.json
        - npm install
        - npm test
      shell: BASH
      run_next: IN_SOFT_PARALLEL
