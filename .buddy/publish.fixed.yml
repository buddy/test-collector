- pipeline: Publish master version
  refs:
    - refs/heads/master
  always_from_scratch: true
  auto_clear_cache: true
  fail_on_prepare_env_warning: true
  variables:
    - key: VERSION_BUMP_TYPE
      type: VAR
  actions:
    - action: Select version bump
      type: WAIT_FOR_VARIABLES
      variables:
        - key: VERSION_BUMP_TYPE
          type: VAR
          defaults: |-
            patch
            minor
            major
    - action: Install packages
      type: BUILD
      docker_image_name: library/node
      docker_image_tag: 22
      execute_commands:
        - npm ci
      volume_mappings:
        - /:/buddy-works/unit-tests
      shell: BASH
    - action: Build
      type: BUILD
      docker_image_name: library/node
      docker_image_tag: 22
      execute_commands:
        - npm run build
      volume_mappings:
        - /:/buddy-works/unit-tests
      shell: BASH
    - action: Test
      type: BUILD
      docker_image_name: library/node
      docker_image_tag: 22
      execute_commands:
        - npm test
      volume_mappings:
        - /:/buddy-works/unit-tests
      shell: BASH
    - action: Bump version
      type: BUILD
      docker_image_name: library/node
      docker_image_tag: 22
      execute_commands:
        - git config user.email "ci@buddy.works"
        - git config user.name "Buddy CI"
        - 'npm version $VERSION_BUMP_TYPE -m "chore(release): bump version to %s"'
        - git push origin HEAD:master --follow-tags
      volume_mappings:
        - /:/buddy-works/unit-tests
      shell: BASH
    - action: Publish
      type: BUILD
      docker_image_name: library/node
      docker_image_tag: 22
      execute_commands:
        - npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
        - npm publish --no-git-checks --access public
      volume_mappings:
        - /:/buddy-works/unit-tests
      shell: BASH
